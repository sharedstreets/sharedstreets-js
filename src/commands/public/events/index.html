<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-a-fit=no">


    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <meta charset='utf-8' />
    <title>SharedStreets Analysis</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet' />
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.css' type='text/css' />


    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; right: 400px; width:100%; }
        #sidebar { position:absolute; right:0; top:0; bottom:0; width:400px; padding-top: 20px; }
    </style>
  </head>
  <body>
    <div>
        <div id='map'></div>
        <div id='sidebar'>
            <div id="head" class="container">
                <h4>SharedStreets</h4>
                <b>Pickup/Dropoff Analysis</b>

                <div style="margin-top: 20px;" id="head" class="container">

                    <canvas id="bar-chart" width="600" height="350"></canvas>

                    <div id="typeSelector">
                        <b>Display:</b>
                        <p>
                            <select name="type"><option value="rank">Ranked Blockface</option><option value="bins" selected>Hourly Average Count</option></select>
                        </p>
                    </div>
                    

                    <p><b>Hours:</b> <input type="text" id="hours" value="0-23"></p>
                    
                    <b>Days of week: </b>
                    <p>
                        <label><input type="checkbox" name="days" value="0" checked> Mon </label>
                        <label><input type="checkbox" name="days" value="1" checked> Tue </label>
                        <label><input type="checkbox" name="days" value="2" checked> Wed </label>
                        <label><input type="checkbox" name="days" value="3" checked> Thu </label>
                        <label><input type="checkbox" name="days" value="4" checked> Fri </label>
                        <label><input type="checkbox" name="days" value="5" checked> Sat </label>
                        <label><input type="checkbox" name="days" value="6" checked> Sun </label>
                    </p>
                
                    <b>Weeks:</b>
                    <p>
                        <div id="weeks">
                        
                        </div>
                    </p>

                    <a href="#" id="downloadJson">Download GeoJSON</a>
                    <span id="loadingData">Loading data...</span>

                </div>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.3.0/Chart.min.js"></script>
    
    <script>
        var currentJSON = {};
        var startHour = 0;
        var endHour = 23;
        var days = [0,1,2,3,4,5,6];
        var weeks = [];
        var periodFilter = [];

        function calcPeriodFilter() {

            periodFilter = days.map((day) => {
                var dayOffset = day * 24;

                var filter = (startHour + dayOffset);

                if(endHour != null) {
                    var adjustedEndHour = endHour;
                    if(endHour < startHour)
                        adjustedEndHour = endHour + 24;
                    filter = filter + '-' + (adjustedEndHour + dayOffset);
                }

                return filter;
            });

            console.log(periodFilter);
            requestData();
        }        

        function processHours() {

            var hourParts = $('#hours').val().split("-");
            startHour = parseInt(hourParts[0]);

            if(hourParts[1])
                endHour = parseInt(hourParts[1]);
            else 
                endHour = null;

            calcPeriodFilter();
        }

        function processDays() {
            days = [];
            $('input[name=days]:checked').each(function() {
                days.push(parseInt($(this).val()));
            });
            //console.log(days);
            calcPeriodFilter();
        }
        
        function processWeeks() {
            weeks = [];
            $('input[name=weeks]:checked').each(function() {
                weeks.push($(this).val());
            });
            console.log(weeks);
            requestData();
        }

        processDays();
        processWeeks();
        processHours();

        $(document).ready(function() {   
            
            $("#typeSelector").hide();
            $("#downloadJson").hide();
            $("#loadingData").hide();

            $.getJSON( '/api/weeks', (weeksData) => {
                weeks = []
                weeksData.forEach((week) => {
                    weeks.push(week);
                    $("#weeks").append($("<label>").text(" " + week).prepend(
                        $("<input>").attr('type', 'checkbox').attr('name', 'weeks').val(week).prop('checked', true)
                    ));
                });
            });

            $('input[name=days]').change(function() {
                processDays();
            });

            $("#hours").change(function() {
                processHours();
            });

            $("#weeks").change(function() {
                processWeeks();
            });

             $('select[name=type]').change(function() {
                processHours();
            });
        });

        mapboxgl.accessToken = 'pk.eyJ1IjoidHJhbnNwb3J0cGFydG5lcnNoaXAiLCJhIjoiY2p1ZHg0ZjB3MTN4cDQ0cnZsaHFoYXFqZSJ9.CQMFwPBVDEarrn5Yr5MJ_g';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            zoom: 13,
            center: [-77.0369, 38.9072]  //-79.3832, 43.6532  -77.0369, 38.9072
        });

        var polygon = null;

        function requestData() {

            if(polygon) {

                $("#downloadJson").hide();
                $("#loadingData").show();

                var requestData = {
                    'weeks' : weeks.join(','),
                    'periodFilter':periodFilter.join(','),
                    'typeFilter':'pickup:5;dropoff:10',
                    'polygon':polygon
                };

                var queryType = $('select[name=type]').val();

                $.getJSON( '/api/summary', requestData, (data) => {
                    buildChart(data);
                });

                $.getJSON( '/api/' +  queryType, requestData, (data) => {

                    map.getSource("rankData").setData({type:"FeatureCollection", features:[]});
                    map.getSource("binData").setData({type:"FeatureCollection", features:[]});

                    if(queryType == 'bins')
                        map.getSource("binData").setData(data);

                    if(queryType == 'rank')
                        map.getSource("rankData").setData(data);

                    var json = JSON.stringify(data),
                    blob = new Blob([json], {type: "octet/stream"}),
                    url = window.URL.createObjectURL(blob);
                    
                    $("#downloadJson").attr("href", url);
                    $("#downloadJson").attr("target", "_blank");
                    $("#downloadJson").attr("download", "dc_data.geojson");

                    $("#downloadJson").show();
                    $("#loadingData").hide();
                });
            }
        }
    
        var draw = new MapboxDraw({
          displayControlsDefault: false,
          controls: {
            polygon: true,
            trash: false
          }
        });
    

        map.on('load', function() {

            map.addControl(draw, 'top-right');
                map.on('draw.selectionchange', () => {
                const mode = draw.getMode();
                const selected = draw.getSelectedIds()[0];
        
                if (selected && mode === 'simple_select') {
                    draw.changeMode('direct_select', { featureId: selected });
                }
            });

            map.addSource("binData",{
                "type": "geojson",
                "data": {type:"FeatureCollection", features:[]}
            });      
        
            map.addLayer({
                "id": "binOverlay",
                "type": "circle",
                "source": "binData",
                "paint": {
                    'circle-radius': {
                          'property': 'periodAverageCount',  
                          'type': 'exponential',
                          'stops': [[0.01, 1],
                                    [3, 15]]
                    
                      },
                      'circle-color': [
                                    'match',
                                    ['get', 'type'],
                                    'pickup', 'blue',
                                    'dropoff', 'red',
                                    /* other */ '#ccc'
                                    ],
                      'circle-opacity': 0.5
                  }
            });

            map.addSource("rankData",{
                "type": "geojson",
                "data": {type:"FeatureCollection", features:[]}
            });      
        
            map.addLayer({
                "id": "rankOverlay",
                "type": "line",
                "source": "rankData",
                "paint": {
                      'line-width': 5,
                      'line-opacity': ['rank'],
                      'line-color': [
                                    'match',
                                    ['get', 'type'],
                                    'pickup', 'blue',
                                    'dropoff', 'red',
                                    /* other */ '#ccc'
                                    ]
                  }
            });
      
            map.on('draw.create', async (e) => {
                if(e && e.features[0]){ 
                    draw.delete(e.features[0].id);
                    polygon = JSON.stringify(e.features[0]);
                    requestData();
                }
            });

        });

        var bar_chart;
        function buildChart(data) {

            var hours = ["0", "1", "2", "3", "4", "4","6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23"];
            var datasets = [];
            datasets.push({
                label: "Pickups",
                data: data['pickup'],
                backgroundColor: "#00f",
                hoverBorderWidth: 0
            });

            datasets.push({
                label: "Dropoffs",
                data: data['dropoff'],
                backgroundColor: "#f00",
                hoverBorderWidth: 0
            });

            var dataObj = {
                labels: hours,
                datasets: datasets
            };

            if(bar_chart) {
                bar_chart.config.data = dataObj;
                bar_chart.update();
            }
            else {
                var bar_ctx = document.getElementById('bar-chart');
                var numberWithCommas = function(x) {
                    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                };

                bar_chart = new Chart(bar_ctx, {
                    type: 'bar',
                    data: dataObj,
                    options:{ 
                        animation:false,
                        scales: {
                        xAxes: [{ 
                            stacked: true, 
                            gridLines: { display: false },
                            }],
                        yAxes: [{ 
                            stacked: true,
                            ticks: {
                                    beginAtZero: true,
                                    steps: 10,
                                    stepValue: 0.0001,
                                    suggestedMax: 0.01
                                } 
                            }],
                        },
                        legend: {display: true}
                    },
                    
                }
                );
            }
        }
    </script>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
      </body>
</html>